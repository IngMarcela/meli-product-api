version: 2.1

executors:
  go-executor:
    docker:
      - image: cimg/go:1.21 # Usá tu versión de Go
    working_directory: ~/repo

jobs:
  test:
    executor: go-executor
    steps:
      - checkout
      - run: go mod tidy
      - run: go test -coverprofile=coverage.out ./...
      - run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage is below 80% (current: $COVERAGE%)"
            exit 1
          fi
          echo "Coverage is good: $COVERAGE%"

workflows:
  test:
    jobs:
      - test
